<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
</head>

<body>

<div id="container">
</div>

<script>
var fieldWidth = 54;
var fieldHeight = 30;

var changeDirProb = 0.1;   // The likelyhood that an ant will change direction

// Add a canvas, sized appropriately
var canvtag = '<canvas id="antField" width="'+(fieldWidth*20)+'" height="'+(fieldHeight*20)+'" style="border:1px solid #000000;">';
var canvas = $(canvtag);
$('#container').append(canvas);
var ctx = canvas.get(0).getContext("2d");

// Create the ants and clear the scent field
var farm = new Farm( fieldWidth, fieldHeight, 160 );

setInterval( function() {
    farm.step();
}, 50 );


//----------------------------------------------------------------------

function Farm(width, height, numAnts) {
    // create the field to hold the scent trail
    this.width = width;
    this.height = height;
    this.scentField = new Field(width, height, function(x,y) { return 0 } ); 

    // Create a set of random ants
    this.numAnts = numAnts;
    this.ants = [];
    for (var i = 0; i < numAnts; i++)
        this.ants[i] = new Ant(this);


    //------------------------------------------------------------------------
    // Returns true if the specified position is valid (within the field)

    this.validPosition = function(dest) {
        return ((dest[0] >= 0) && (dest[1] >= 0) && (dest[0] < this.width) && (dest[1] < this.height));
    }

    //------------------------------------------------------------------------
    // Calculate the new position given a current position and a direction
    // return null if the new position would be outside the field

    this.posRelative = function(pos, direction) {
        var antX = pos[0], antY = pos[1];

        // Calculate the new position based on direction
        if (direction == 0)           // right
            var dest = [antX+1, antY]
        else if (direction == 1)      // left
            var dest = [antX-1, antY];
        else if (direction == 2)      // down
            var dest = [antX, antY+1];
        else if (direction == 3)      // up
            var dest = [antX, antY-1];

        // If that position is within the field, return it, otherwise return
        // null to indicate it was a bad location
        return this.validPosition(dest) ? dest : null;
    }

    //------------------------------------------------------------------------
    //  Advance the farm simulation one step, redraw the canvas

    this.step = function() {
        // Update the state and position of the ants
        for (var i=0; i < this.ants.length; i++)
            this.ants[i].step();

        // update the scent field
        this.scentStep();

        // redraw the canvas based on the new state
        this.updateCanvas( this.scentColor(this.scentField) );
    }


    //------------------------------------------------------------------------
    //  Redraw the canvas

    this.updateCanvas = function(field) {
        // Redraw the scent trail, with the color intensity reflecting the
        // scent trail intensity
        for (var y = 0; y < this.height; y++)
            for (var x = 0; x < this.width; x++) {
                ctx.fillStyle = field.field[y][x];
                ctx.fillRect(x*20,y*20,20,20);

            }

        // Draw the ants as white dots
        for (var i = 0; i < this.ants.length; i++) {
            var antX = this.ants[i].antX, antY = this.ants[i].antY;

            ctx.beginPath();
            ctx.arc((antX*20)+10, (antY*20)+10, 5, 0, 2 * Math.PI, false);
            ctx.fillStyle = 'white';
            ctx.fill();
            
        }
    }


    this.scentStep = function() {
       var inField = this.scentField;
       var f = new Field(this.width, this.height, function(x,y) {
           return Math.max(0, inField.field[y][x]-4);
       } );

       for (var i = 0; i < this.ants.length; i++) {
            var antX = this.ants[i].antX, antY = this.ants[i].antY;
            f.field[antY][antX] = Math.min(255, f.field[antY][antX]+85);
       }

       this.scentField = f;
         
    }

    this.scentStrength = function( x, y ) {
        if ((x >= 0) && (x < this.width) && (y >=0) && (y < this.height))
           return this.scentField.field[y][x];
        else
           return 0;
    }


    this.scentColor = function(inField) {
        return new Field(this.width, this.height, function(x,y) {
            return "rgb("+inField.field[y][x]+","+0+","+0+")";
        } );
    }

    this.findStrongestScentDirection = function (loc) {
        var antX = loc[0];
        var antY = loc[1];

        var strongestDir = -1;
        var strongestVal = 0;

        function test_and_replace( value, direction ) {
            if (value > strongestVal) {
                strongestVal = value;
                strongestDir = direction;
            }
        }

        // to the right
        test_and_replace( farm.scentStrength(antX+1, antY-1) + farm.scentStrength(antX+1, antY) + farm.scentStrength(antX+1, antY+1), 0 ); 

        // to the left
        test_and_replace( farm.scentStrength(antX-1, antY-1) + farm.scentStrength(antX-1, antY) + farm.scentStrength(antX-1, antY+1), 1 ); 

        // test to the down
        test_and_replace( farm.scentStrength(antX-1, antY+1) + farm.scentStrength(antX, antY+1) + farm.scentStrength(antX+1, antY+1), 2 ); 

        // test to the up
        test_and_replace( farm.scentStrength(antX-1, antY-1) + farm.scentStrength(antX, antY-1) + farm.scentStrength(antX+1, antY-1), 3 ); 

        return strongestDir;

    }

}


//----------------------------------------------------------------------
// 'Field' is a 2-dimensional array, calcfunc is a function that
// calculates the value to be stored in the array

function Field(width, height, calcfunc) {
    this.width = width;
    this.height = height;

    this.field = new Array(height);
    for (var y = 0; y < height; y++) {
        this.field[y] = new Array(width);

        for (var x = 0; x < width; x++) 
            this.field[y][x] = calcfunc(x,y);
   }

   return this;
}


//============================================================================
// Ant encapsulates the behavior of the entities in the field

function Ant(farm) {
    // randomly position the ant and give it a direction
    this.antX = (Math.random() * fieldWidth) | 0;
    this.antY = (Math.random() * fieldHeight) | 0;
    this.direction = (Math.random() * 4) | 0;

    // a refernce to the farm it lives in when it needs to interact with
    // the outside world
    this.farm = farm;
}


Ant.prototype.oppositeDir = function( a, b ) {
    // 0 (left) is the opposite of 1 (right); and 2 (down) is the opposite of 3 (up)
    var opposites = [1, 0, 3, 2];
    return opposites[a] == b;    
}


Ant.prototype.step = function () {
    var antData = [this.antX, this.antY, this.direction]
    var newPos = this.farm.posRelative( antData, this.direction ); 

    var strongestScentDir = farm.findStrongestScentDirection(antData);
    if ((strongestScentDir != -1) && (!this.oppositeDir(this.direction, strongestScentDir)))
        this.direction = strongestScentDir
    else {
        var changeDir = ((Math.random() <= changeDirProb) || (newPos == null));  //(!canMove(projectedLocation(antData)));
        if (changeDir) 
            this.direction = Math.random() * 4 | 0;
    }

    if (this.direction == 0)
        this.antX = Math.min( this.antX + 1, fieldWidth-1 );
    else if (this.direction == 1)
        this.antX = Math.max( this.antX - 1, 0 );
    else if (this.direction == 2)
        this.antY = Math.min( this.antY + 1, fieldHeight-1 );
    else if (this.direction == 3)
        this.antY = Math.max( this.antY - 1, 0 );
}

</script>

</body>
</html>

