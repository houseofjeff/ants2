<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
</head>

<body>

<div id="container">
</div>

<script>
var fieldWidth = 54;
var fieldHeight = 30;

var changeDirProb = 0.1;   // The likelyhood that an ant will change direction

// Add a canvas, sized appropriately
var canvtag = '<canvas id="antField" width="'+(fieldWidth*20)+'" height="'+(fieldHeight*20)+'" style="border:1px solid #000000;">';
var canvas = $(canvtag);
$('#container').append(canvas);
var ctx = canvas.get(0).getContext("2d");

// Create the ants and clear the scent field
var farm = new Farm( fieldWidth, fieldHeight, 160 );

setInterval( function() {
    farm.step();
}, 50 );


//----------------------------------------------------------------------

function Farm(width, height, numAnts) {
    this.width = width;
    this.height = height;
    this.numAnts = numAnts;
    this.ants = [];
    this.scentField = new Field(width, height, function(x,y) { return 0 } ); 
   
    for (var i = 0; i < numAnts; i++)
        this.ants[i] = new Ant(this);


    this.validPosition = function(dest) {
        return ((dest[0] >= 0) && (dest[1] >= 0) && (dest[0] < this.width) && (dest[1] < this.height));
    }

    this.moveRelative = function(pos, direction) {
        var antX = pos[0], antY = pos[1];

        if (direction == 0)
            var dest = [antX+1, antY]
        else if (direction == 1)
            var dest = [antX-1, antY];
        else if (direction == 2)
            var dest = [antX, antY+1];
        else if (direction == 3)
            var dest = [antX, antY-1];

        return this.validPosition(dest) ? dest : null;
    }

    this.step = function() {
        for (var i=0; i < this.ants.length; i++)
            this.ants[i].step();

        this.updateCanvas( this.scentColor(this.scentField) );
    }


    this.updateCanvas = function(field) {
        this.scentField = this.scentStep(this.scentField);
        for (var y = 0; y < this.height; y++)
            for (var x = 0; x < this.width; x++) {
                ctx.fillStyle = field.field[y][x];
                ctx.fillRect(x*20,y*20,20,20);

            }

        for (var i = 0; i < this.ants.length; i++) {
            var antX = this.ants[i].antX, antY = this.ants[i].antY;

            ctx.beginPath();
            ctx.arc((antX*20)+10, (antY*20)+10, 5, 0, 2 * Math.PI, false);
            ctx.fillStyle = 'white';
            ctx.fill();
            
        }
    }


    this.scentStep = function(inField) {
       var f = new Field(this.width, this.height, function(x,y) {
           return Math.max(0, inField.field[y][x]-4);
       } );

       for (var i = 0; i < this.ants.length; i++) {
            var antX = this.ants[i].antX, antY = this.ants[i].antY;
            f.field[antY][antX] = Math.min(255, f.field[antY][antX]+85);
       }

       return f;
         
    }

    this.scentStrength = function( x, y ) {
        if ((x >= 0) && (x < this.width) && (y >=0) && (y < this.height))
           return this.scentField.field[y][x];
        else
           return 0;
    }


    this.scentColor = function(inField) {
        return new Field(this.width, this.height, function(x,y) {
            return "rgb("+inField.field[y][x]+","+0+","+0+")";
        } );
    }

    this.findStrongestScentDirection = function (loc) {
        var antX = loc[0];
        var antY = loc[1];

        var strongestDir = -1;
        var strongestVal = 0;

        // test to the right

        var testStrength = farm.scentStrength(antX+1, antY-1) + farm.scentStrength(antX+1, antY) + farm.scentStrength(antX+1, antY+1); 
        if (testStrength > strongestVal) {
            strongestVal = testStrength;
            strongestDir = 0;
        }

        // test to the left
        var testStrength = farm.scentStrength(antX-1, antY-1) + farm.scentStrength(antX-1, antY) + farm.scentStrength(antX-1, antY+1); 
        if (testStrength > strongestVal) {
            strongestVal = testStrength;
            strongestDir = 1;
        }

        // test to the down
        var testStrength = farm.scentStrength(antX-1, antY+1) + farm.scentStrength(antX, antY+1) + farm.scentStrength(antX+1, antY+1); 
        if (testStrength > strongestVal) {
            strongestVal = testStrength;
            strongestDir = 2;
        }

        // test to the up
        var testStrength = farm.scentStrength(antX-1, antY-1) + farm.scentStrength(antX, antY-1) + farm.scentStrength(antX+1, antY-1); 
        if (testStrength > strongestVal) {
            strongestVal = testStrength;
            strongestDir = 3;
        }

        return strongestDir;

    }

}


Farm.prototype.oppositeDirection = function( dirA, dirB ) {
    var opposites = [1, 0, 3, 2];
    return opposites[dirA] == dirB;    
}



//----------------------------------------------------------------------
// 'Field' is a 2-dimensional array

function Field(width, height, calcfunc) {
    this.width = width;
    this.height = height;

    this.field = new Array(height);
    for (var y = 0; y < height; y++) {
        this.field[y] = new Array(width);

        for (var x = 0; x < width; x++) 
            this.field[y][x] = calcfunc(x,y);
   }
}


//----------------------------------------------------------------------

function Ant(farm) {
    this.antX = (Math.random() * fieldWidth) | 0;
    this.antY = (Math.random() * fieldHeight) | 0;
    this.direction = (Math.random() * 4) | 0;
    this.farm = farm;
}


Ant.prototype.oppositeDir = function( a, b ) {
    var opposites = [1, 0, 3, 2];
    return opposites[a] == b;    
}


Ant.prototype.step = function () {
    var antData = [this.antX, this.antY, this.direction]
    var newPos = this.farm.moveRelative( antData, this.direction ); 

    var strongestScentDir = farm.findStrongestScentDirection(antData);
    if ((strongestScentDir != -1) && (!this.oppositeDir(this.direction, strongestScentDir)))
        this.direction = strongestScentDir
    else {
        var changeDir = ((Math.random() <= changeDirProb) || (newPos == null));  //(!canMove(projectedLocation(antData)));
        if (changeDir) 
            this.direction = Math.random() * 4 | 0;
    }

    if (this.direction == 0)
        this.antX = Math.min( this.antX + 1, fieldWidth-1 );
    else if (this.direction == 1)
        this.antX = Math.max( this.antX - 1, 0 );
    else if (this.direction == 2)
        this.antY = Math.min( this.antY + 1, fieldHeight-1 );
    else if (this.direction == 3)
        this.antY = Math.max( this.antY - 1, 0 );
}

</script>

</body>
</html>

